name: Update Relic Data - Start & End Only

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'    
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install dependencies
        run: npm ci || npm install

     
      - name: Check if this is the right moment for update
        id: should_update
        shell: bash
        run: |
          EVENT_FILE="data/eventRelic.json"
          UPDATE_NEEDED="false"
          MARKER_FILE=".update-markers"

          if [ ! -f "$EVENT_FILE" ]; then
            echo "No periods file → full update"
            UPDATE_NEEDED="true"
          else
            NOW=$(date +%s)
            
            # Читаем все периоды
            while IFS= read -r period; do
              start=$(echo "$period" | jq -r '.startDate')
              end=$(echo "$period" | jq -r '.endDate')
              
              [ -z "$start" ] || [ -z "$end" ] && continue
              
              start_ts=$(date -d "$start" +%s 2>/dev/null) || continue
              end_ts=$(date -d "$end" +%s 2>/dev/null)     || continue
              
             # Окно начала: от старта до +12 часов
            if [ $NOW -ge $start_ts ] && [ $NOW -le $((start_ts + 43200)) ]; then
              if ! grep -q "start:${start}" "$MARKER_FILE" 2>/dev/null; then
                echo "→ Start window detected ($start), not updated yet"
                UPDATE_NEEDED="true"
                echo "start:${start}" >> "$MARKER_FILE"
                break
              fi
            fi

            # Окно конца: последние 36 часов до конца + 12 часов после конца
           if [ $NOW -ge $end_ts ] && [ $NOW -le $((end_ts + 43200)) ]; then
            if ! grep -q "end:${end}" "$MARKER_FILE" 2>/dev/null; then
              echo "→ End window detected ($end), not updated yet"
              UPDATE_NEEDED="true"
              echo "end:${end}" >> "$MARKER_FILE"
              break
            fi
          fi
            done < <(jq -c '.varziaPeriod[]' "$EVENT_FILE" 2>/dev/null || echo "")
          fi

          echo "update_needed=$UPDATE_NEEDED" >> "$GITHUB_OUTPUT"

      - name: Run update scripts
        if: steps.should_update.outputs.update_needed == 'true'
        run: |
          node updatingData/update_data.js
          node updatingData/prime_img_frame.js
          node updatingData/prime_img_weapon.js

      - name: Commit changes + marker file
        if: steps.should_update.outputs.update_needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/ img/ .update-markers
          git commit -m "auto: update at period start/end" --allow-empty || true
          git push || true

      